---
title: "Механизмы Claude Code"
updated: 2025-12-11
version: 5
scope: "claude_reference"
priority: high
---

# Механизмы Claude Code

## Кратко

Справочник по механизмам Claude Code Extension: MCP-серверы (подключение к внешним сервисам), субагенты (AI-специалисты с изолированным контекстом), промпты (роли без изоляции), скиллы (процедуры для повторяемых задач). Используется при создании новых агентов, настройке MCP или скиллов. Не для ежедневной работы — для настройки среды.

---

## Основной стек

| Компонент | Инструмент |
|-----------|------------|
| IDE | VS Code |
| AI-ассистент | Claude Code Extension |
| Авторизация | Claude Max подписка |
| Актуальные данные | MCP-серверы |
| Специалисты | Субагенты, промпты |

## Связанные файлы

- meta/meta_context/ai_team.md — каталог AI-агентов (когда какого использовать)
- .claude/agents/ — файлы субагентов (пока только context-editor)
- dev/prompts/ — промпты ролей (CTO, Dify-эксперт)

---

## Механизмы

| Механизм | Что это | Когда использовать | Где лежит |
|----------|---------|-------------------|-----------|
| **MCP** | Доступ к сервисам + актуальные данные | Нужен доступ к n8n, Supabase, документации | `.mcp.json` |
| **Субагент** | AI с изолированным контекстом | Специалист для автономной работы | `.claude/agents/` |
| **Промпт** | Роль без изоляции | Диалог в основном треде | `dev/prompts/` |
| **Скилл** | Инструкции + скрипты для повторяемых задач | Одна и та же процедура много раз | `.claude/skills/` |

### Принцип различия

- **MCP** = инструменты + данные (что использовать)
- **Субагент** = AI-специалист с изоляцией (кто делает автономно)
- **Промпт** = роль без изоляции (кто обсуждает)
- **Скилл** = процедура (как делать повторяемое, не AI)

---

## MCP-серверы

MCP (Model Context Protocol) — подключение AI к внешним сервисам. Это "руки" Claude для работы с n8n, Supabase и др.

### Текущие MCP (активны)

| MCP | Что делает | Статус |
|-----|------------|--------|
| **n8n-mcp** | Создаёт/редактирует workflow, 543 ноды, 2709 шаблонов | ✅ Подключен |
| **supabase** | SQL, таблицы, миграции, управление схемой | ✅ Подключен |

### Возможности n8n-mcp (39+ инструментов)

| Категория | Что может Claude |
|-----------|------------------|
| **Создание** | `n8n_create_workflow` — полное создание workflow |
| **Редактирование** | `n8n_update_full_workflow`, `n8n_update_partial_workflow` |
| **Тестирование** | `n8n_test_workflow` — запуск и проверка |
| **Автоисправление** | `n8n_autofix_workflow` — автоматический фикс ошибок |
| **Шаблоны** | `n8n_deploy_template` — деплой из 2709 готовых шаблонов |
| **Документация** | `search_nodes`, `get_node` — доступ к документации 543 нод |

### Возможности Supabase MCP

| Что может Claude |
|------------------|
| Выполнять SQL запросы (`execute_sql`) |
| Создавать таблицы и миграции (`apply_migration`) |
| Читать схему (`list_tables`, `list_extensions`) |
| Генерировать TypeScript типы |

**⚠️ Ограничение:** Supabase MCP рекомендуют только для dev, не production.

### Хранение конфигурации

MCP хранятся в **user-level** (`~/.claude.json`), НЕ в проекте — чтобы API ключи не попали на GitHub.

### Команды управления MCP

```bash
# Добавить MCP (stdio)
claude mcp add n8n-mcp \
  -e N8N_API_URL=https://svaib-app.app.n8n.cloud \
  -e N8N_API_KEY=your-key \
  -- npx n8n-mcp

# Добавить MCP (http)
claude mcp add supabase "https://mcp.supabase.com/mcp?project_ref=xxx" \
  -t http \
  -H "Authorization: Bearer your-token"

# Проверить статус
claude mcp list

# Детали конкретного MCP
claude mcp get n8n-mcp

# Удалить
claude mcp remove n8n-mcp -s local
```

### Токены и сроки (ВАЖНО!)

| MCP | Срок действия | Когда обновить |
|-----|---------------|----------------|
| n8n-mcp | 90 дней | ~11 марта 2026 |
| supabase | 30 дней | ~10 января 2026 |

**При истечении:** Создать новый токен, выполнить `claude mcp remove` + `claude mcp add`

---

## Субагенты

AI-специалисты с изолированным контекстом. Claude делегирует им задачи автоматически или по запросу.

**Расположение:** `.claude/agents/*.md`

**Вызов:**
```
# Автоматически — Claude решает по description
> "Создай workflow для транскрибации"

# Явно
> "Используй n8n-expert для создания webhook"

# Список
> /agents
```

### Формат файла субагента

```markdown
---
name: n8n-expert
description: "Создание n8n workflow. Используй для любых задач с workflow, webhooks, интеграциями."
tools: Read, Write, Edit, Bash
model: sonnet
---

Ты n8n-разработчик проекта svaib.

## Контекст
Прочитай: dev/dev_context/svaib_architecture.md

## Правила
- Используй MCP n8n-mcp для документации и API
- Валидируй workflow перед деплоем
```

**Поля frontmatter:**
- `name` — имя (обязательно)
- `description` — когда использовать (обязательно, это главный триггер)
- `tools` — доступные инструменты через запятую (опционально, по умолчанию все)
- `model` — модель: sonnet, opus, haiku (опционально)

**Документация:** https://docs.claude.com/en/docs/claude-code/sub-agents

---

### Взаимодействие координатор-субагент

**Что субагент видит:**
- Задание от координатора (verbatim)
- Свой системный промпт (`.claude/agents/*.md`)
- Файлы проекта (через Read/Glob/Grep)
- **НЕ видит:** историю диалога, предыдущий контекст разговора

**Что координатор получает:**
- Только финальный результат субагента
- НЕ видит внутренние рассуждения и промежуточные шаги

**Workflow координатора:**
1. Сформулировать конкретное задание для субагента
2. Дождаться результата
3. **Проверить через `git diff`** — что именно изменилось
4. Если нужны уточнения — `resume agent <id>`
5. Показать пользователю проверенный результат

**Как координатор выбирает субагента:**
Субагенты видны как инструменты (наряду с Read, Write, Bash). Description = критерий выбора. Чем точнее description описывает текущую задачу, тем выше шанс автоматического вызова.

**Best practices для субагентов:**

| Аспект | Рекомендация |
|--------|--------------|
| Description | Добавлять триггеры: "ИСПОЛЬЗУЙ ПРОАКТИВНО", "ОБЯЗАТЕЛЬНО использовать при..." |
| Контекст | В начале промпта указать какие файлы читать: "Прочитай: `path/to/file.md`" |
| Возврат | Субагент должен возвращать список изменённых файлов (абсолютные пути) |
| Single Source | Не дублировать правила — ссылаться на SOURCE файлы |
| Изоляция | Помнить: субагент НЕ видит историю диалога, писать полное ТЗ |

---

## Скиллы

Папки с инструкциями и скриптами для повторяемых задач. Claude загружает автоматически по контексту.

**Расположение:** `.claude/skills/`

**Работают:** Claude Code, Claude.ai, API

### Структура

```
skill-name/
├── SKILL.md           ← инструкции + YAML frontmatter (обязательно)
├── scripts/           ← исполняемый код
├── references/        ← документация
└── assets/            ← шаблоны, файлы для вывода
```

**Документация:** https://support.claude.com/en/articles/12512176-what-are-skills

---

## Claude for Chrome

Отдельный инструмент для GUI-задач в браузере. **Изолирован от Claude Code** — нет общей памяти, нет MCP.

### Что умеет

| Возможность | Описание |
|-------------|----------|
| Видит интерфейс | Распознаёт кнопки, формы, меню как человек |
| Кликает и заполняет | Автономно выполняет действия в браузере |
| Multi-tab | Работает с несколькими вкладками одновременно |
| Фоновая работа | Продолжает работать когда переключаешься |

### Когда использовать

| Задача | Инструмент |
|--------|------------|
| Настройка в Google Cloud Console | Claude for Chrome |
| Настройка в Supabase Dashboard (GUI) | Claude for Chrome |
| Любые GUI-задачи в браузере | Claude for Chrome |
| Код, файлы, n8n workflow, SQL | Claude Code + MCP |

### Ограничения

- ❌ Нет MCP connections (изолирован от Claude Code)
- ❌ Нет памяти между сессиями
- ❌ Медленнее человека (скриншоты после каждого действия)
- ❌ Не работает с финансовыми сервисами, adult-контентом

### Best practices

1. Создавай shortcuts для повторяющихся задач
2. Начинай с "ask before acting" режима
3. После отладки — включай автономный режим для trusted sites

---

## Структура файлов проекта

```
.claude/
├── agents/          ← субагенты
└── skills/          ← скиллы

~/.claude.json       ← MCP-серверы (user-level, не в проекте!)

dev/
├── prompts/         ← промпты ролей
└── dev_context/     ← документация

CLAUDE.md            ← общие правила проекта
```

---

## Ссылки

| Что | Документация |
|-----|--------------|
| Claude Code | https://docs.claude.com/en/docs/claude-code/overview |
| MCP | https://docs.claude.com/en/docs/mcp |
| Субагенты | https://docs.claude.com/en/docs/claude-code/sub-agents |
| Скиллы | https://support.claude.com/en/articles/12512176-what-are-skills |
| n8n-mcp | https://github.com/czlonkowski/n8n-mcp |
| supabase-mcp | https://supabase.com/docs/guides/getting-started/mcp |
| context7 | https://github.com/upstash/context7 |
| Claude for Chrome | https://support.claude.com/en/articles/12431227-simplify-your-browsing-experience-with-claude-for-chrome |

---

## Ключевые инсайты (исследование 11.12.2025)

Источники: документация n8n-mcp, Supabase MCP, Claude for Chrome, n8n Community.

### n8n-mcp — это прорыв

- **39+ инструментов** для полного управления n8n
- **543 ноды** с документацией, **2709 шаблонов**
- Claude может **создавать workflow с нуля**, не только редактировать
- **Автоисправление ошибок** (`n8n_autofix_workflow`)
- Раньше настройка workflow занимала часы/дни руками → теперь минуты через MCP

### Supabase MCP — только для dev

- Официальная рекомендация: **"never connect to production data"**
- Есть read-only режим для безопасности
- Для production — ручной approve или отдельные credentials

### Claude for Chrome — изолирован

- **Нет MCP connections** — это отдельный инструмент
- **Нет памяти между сессиями**
- **Медленнее человека** — делает скриншот после каждого действия
- Хорош для: GUI-настройки, form filling, multi-tab workflows
- Не работает с: финансовыми сервисами, adult-контентом

### Best practice: разделение инструментов

| Задача | Инструмент |
|--------|------------|
| Код, файлы, n8n, SQL | Claude Code + MCP |
| GUI в браузере | Claude for Chrome |
| Брейншторм, тексты | Claude Chat |

### Токены требуют обновления

- Supabase: **30 дней** — короткий срок, следить!
- n8n: **90 дней** — более комфортно
- Добавить напоминание в календарь